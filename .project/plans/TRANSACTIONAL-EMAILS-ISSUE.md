# Transactional Emails for Marketplace Features

**Issue Type:** Feature  
**Priority:** Medium  
**Status:** Backlog  
**Project:** Marketplace Features

---

## Problem

Marketplace Features mangler transactional email notifications til brugere. I øjeblikket sendes kun in-app notifications, men brugere skal også modtage email notifications for vigtige events som order confirmations, shipping updates, payment reminders, osv.

## Solution

Implementer transactional email service der sender emails til brugere for alle vigtige marketplace events. Emails skal være professionelle, informative, og inkludere klare call-to-actions.

---

## Transactional Email Types

### Order & Payment Emails (4 emails)

#### 1. Order Confirmation (Buyer)
**Trigger:** Payment successful, order created  
**Recipient:** Buyer  
**Subject:** "Order Confirmation - Order #[orderCode]"  
**Content:**
- Order details (item, price, quantity)
- Shipping address
- Shipping method
- Total amount
- Payment confirmation
- Estimated delivery date
**Actions:**
- View order details link
- Track shipment link (when available)

#### 2. Order Received (Seller)
**Trigger:** Payment successful, order created  
**Recipient:** Seller  
**Subject:** "New Order - Order #[orderCode]"  
**Content:**
- Order details (item, price, quantity)
- Buyer info (name, shipping address)
- Total amount (seller payout amount)
- Shipping method selected
**Actions:**
- View order details link
- Generate shipping label button/link (when HUD-42 complete)

#### 3. Payment Failed (Buyer)
**Trigger:** Payment intent failed  
**Recipient:** Buyer  
**Subject:** "Payment Failed - Order #[orderCode]"  
**Content:**
- Error message (user-friendly)
- Order details
- Total amount
**Actions:**
- Retry payment button
- Contact support link

#### 4. Payment Reminder (Buyer)
**Trigger:** Auction won, payment not completed within 24h  
**Recipient:** Buyer (auction winner)  
**Subject:** "Complete Your Payment - Order #[orderCode]"  
**Content:**
- Payment deadline (e.g., "Payment due within 48 hours")
- Order details (item, winning bid amount)
- Shipping method (if selected)
- Total amount
**Actions:**
- Complete payment button
- View order details link

---

### Shipping Emails (4 emails)

#### 5. Shipping Label Ready (Seller)
**Trigger:** Label generated successfully (HUD-42)  
**Recipient:** Seller  
**Subject:** "Shipping Label Ready - Order #[orderCode]"  
**Content:**
- Order code
- Label download link
- Tracking number (if available)
- Shipping address (buyer address or service point)
- Print instructions
**Actions:**
- Download label button
- View order details link
**Note:** Part of HUD-42, but email service deferred

#### 6. Order Shipped (Buyer)
**Trigger:** Label generated by seller (HUD-42)  
**Recipient:** Buyer  
**Subject:** "Your Order Has Shipped - Order #[orderCode]"  
**Content:**
- Order shipped confirmation
- Tracking number
- Estimated delivery date
- Shipping carrier
- Tracking link
**Actions:**
- Track shipment button
- View order details link

#### 7. Order Delivered (Buyer)
**Trigger:** Order status = "delivered" (HUD-39)  
**Recipient:** Buyer  
**Subject:** "Your Order Has Been Delivered - Order #[orderCode]"  
**Content:**
- Delivery confirmation
- Delivery date
- Tracking info
- Item details
**Actions:**
- Leave review button
- Request refund link (if within refund window)
- View order details link

#### 8. Order Delivered (Seller)
**Trigger:** Order status = "delivered" (HUD-39)  
**Recipient:** Seller  
**Subject:** "Order Delivered - Payout Scheduled - Order #[orderCode]"  
**Content:**
- Delivery confirmation
- Payout amount
- Payout scheduled date
- Transaction details
**Actions:**
- View payout details link
- View order details link

---

### Auction Emails (4 emails)

#### 9. Auction Won (Winner)
**Trigger:** Auction ended, user is winner  
**Recipient:** Buyer (auction winner)  
**Subject:** "Congratulations! You Won the Auction - #[itemName]"  
**Content:**
- Winning bid amount
- Item details (name, images)
- Checkout deadline (e.g., "Complete checkout within 48 hours")
- Shipping options preview
**Actions:**
- Complete checkout button
- View item details link

#### 10. Auction Won (Seller)
**Trigger:** Auction ended, winner determined  
**Recipient:** Seller  
**Subject:** "Auction Ended - Winner Determined - #[itemName]"  
**Content:**
- Winning bid amount
- Winner info (name, if available)
- Next steps (wait for payment, then generate label)
- Estimated payout amount
**Actions:**
- View auction details link
- View order details link (when order created)

#### 11. Auction Outbid (Bidder)
**Trigger:** Someone placed higher bid  
**Recipient:** Bidder (who was outbid)  
**Subject:** "You've Been Outbid - #[itemName]"  
**Content:**
- New highest bid amount
- Item details
- Time remaining
- Your previous bid amount
**Actions:**
- Place new bid button
- View auction link

#### 12. Auction Ending Soon (Seller)
**Trigger:** 24h before auction ends  
**Recipient:** Seller  
**Subject:** "Your Auction Ends Soon - #[itemName]"  
**Content:**
- Auction ending reminder
- Current highest bid
- Time remaining
- Number of bids
**Actions:**
- View auction link
- Share auction link

---

### Refund Emails (3 emails)

#### 13. Refund Initiated (Buyer)
**Trigger:** Refund request approved  
**Recipient:** Buyer  
**Subject:** "Refund Initiated - Order #[orderCode]"  
**Content:**
- Refund amount
- Refund reason
- Estimated processing time (e.g., "5-10 business days")
- Original payment method
**Actions:**
- Track refund status link
- View order details link

#### 14. Refund Completed (Buyer)
**Trigger:** Refund processed  
**Recipient:** Buyer  
**Subject:** "Refund Completed - Order #[orderCode]"  
**Content:**
- Refund amount
- Refunded to payment method
- Refund date
- Transaction ID
**Actions:**
- View transaction history link
- View order details link

#### 15. Refund Received (Seller)
**Trigger:** Refund processed  
**Recipient:** Seller  
**Subject:** "Refund Processed - Order #[orderCode]"  
**Content:**
- Refund amount (deducted from payout)
- Refund reason
- Remaining payout amount (if any)
- Transaction details
**Actions:**
- View payout details link
- View order details link

---

### Payout Emails (1 email)

#### 16. Payout Sent (Seller)
**Trigger:** Transfer created (Stripe webhook)  
**Recipient:** Seller  
**Subject:** "Payout Sent - #[amount] EUR"  
**Content:**
- Payout amount
- Payout date
- Transfer ID
- Transaction details (order code, item)
**Actions:**
- View payout details link
- View transaction history link
**Note:** Already has in-app notification, needs email

---

### Identity Verification Emails (3 emails)

#### 17. Identity Verification Approved (Seller)
**Trigger:** Stripe Identity verification approved  
**Recipient:** Seller  
**Subject:** "Identity Verification Approved"  
**Content:**
- Verification approved confirmation
- Can now list items on marketplace
- Verified badge on profile
**Actions:**
- Create listing button
- View profile link

#### 18. Identity Verification Rejected (Seller)
**Trigger:** Stripe Identity verification rejected  
**Recipient:** Seller  
**Subject:** "Identity Verification Review Required"  
**Content:**
- Rejection reason (if available)
- How to appeal
- What documents are needed
- Support contact
**Actions:**
- Request review button
- Contact support link
- View verification status link

#### 19. Identity Verification Review Requested (Seller)
**Trigger:** Review request submitted  
**Recipient:** Seller  
**Subject:** "Review Request Received"  
**Content:**
- Review request received confirmation
- Estimated review time (e.g., "2-3 business days")
- What happens next
**Actions:**
- View verification status link
- Contact support link
**Note:** Already has in-app notification, needs email

---

### Profile Emails (1 email)

#### 20. Profile Completion Reminder (User)
**Trigger:** User tries to list/buy but profile incomplete  
**Recipient:** User  
**Subject:** "Complete Your Profile to Continue"  
**Content:**
- Missing profile fields (specific list)
- Why it's needed (e.g., "Required to list items")
- Benefits of completing profile
**Actions:**
- Complete profile button
- View profile link

---

## Technical Requirements

### Email Service Provider
- **Recommendation:** Resend, SendGrid, eller Postmark
- **Requirements:**
  - Transactional email support
  - Template system
  - Delivery tracking
  - Bounce handling
  - Unsubscribe handling (for transactional, minimal)

### Email Templates
- **Format:** HTML + Plain text
- **Branding:** Huddle logo, colors, fonts
- **Responsive:** Mobile-friendly
- **Accessibility:** WCAG 2.1 AA compliant

### Email Content
- **Language:** Danish (primary), English (future)
- **Tone:** Professional, friendly, clear
- **Personalization:** User name, order details, dynamic content
- **No PII in logs:** Email addresses masked in logs

### Email Delivery
- **Queue System:** Background job queue for email sending
- **Retry Logic:** Exponential backoff for failed sends
- **Rate Limiting:** Respect email provider limits
- **Error Handling:** Log failures, don't block user actions

### Database Schema
- **Table:** `email_logs` (optional, for tracking)
  - `id`, `user_id`, `email_type`, `recipient_email`, `subject`
  - `status` (sent, failed, bounced)
  - `sent_at`, `opened_at`, `clicked_at`
  - `error_message` (if failed)

---

## Implementation Phases

### Phase 1: Email Service Setup
- Choose email provider
- Configure API keys
- Set up email templates (basic)
- Create email service class

### Phase 2: Core Emails (Order & Payment)
- Order Confirmation (Buyer)
- Order Received (Seller)
- Payment Failed (Buyer)
- Payment Reminder (Buyer)

### Phase 3: Shipping Emails
- Shipping Label Ready (Seller) - depends on HUD-42
- Order Shipped (Buyer) - depends on HUD-42
- Order Delivered (Buyer) - depends on HUD-39
- Order Delivered (Seller) - depends on HUD-39

### Phase 4: Auction Emails
- Auction Won (Winner)
- Auction Won (Seller)
- Auction Outbid (Bidder)
- Auction Ending Soon (Seller)

### Phase 5: Refund & Payout Emails
- Refund Initiated (Buyer)
- Refund Completed (Buyer)
- Refund Received (Seller)
- Payout Sent (Seller)

### Phase 6: Identity & Profile Emails
- Identity Verification Approved (Seller)
- Identity Verification Rejected (Seller)
- Identity Verification Review Requested (Seller)
- Profile Completion Reminder (User)

---

## Dependencies

- **HUD-39:** Medusa Order Integration (for order delivered emails)
- **HUD-42:** Shipping Label Generation (for shipping label ready, order shipped emails)
- **HUD-34/HUD-35:** Checkout Flows (for order confirmation emails)

---

## Acceptance Criteria

- [ ] Email service provider configured
- [ ] Email templates created for all 20 email types
- [ ] Emails sent at correct triggers
- [ ] Emails are responsive and accessible
- [ ] Email delivery tracked (optional)
- [ ] Error handling for failed sends
- [ ] No PII in logs
- [ ] Email content in Danish
- [ ] All emails include clear call-to-actions

---

## Future Enhancements

- Email preferences (user can choose which emails to receive)
- Email templates customization (admin can edit templates)
- A/B testing for email content
- Email analytics (open rates, click rates)
- Multi-language support (English, etc.)

---

## Notes

- This issue can be split into smaller issues later (e.g., "Order & Payment Emails", "Shipping Emails", etc.)
- Email service implementation is deferred - focus on identifying all email types first
- Some emails depend on other issues (HUD-39, HUD-42) - implement those first
- Email content should be reviewed by product/design team before implementation

---

**Total Email Types:** 20  
**Estimated Complexity:** High  
**Estimated Time:** 24-32 timer (including email service setup, templates, testing)

